<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQL Query Interface - E-commerce Database</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>SQL Query Interface</h1>
        <p>E-commerce Database Explorer & Learning Tool</p>
      </div>

      <div class="content">
        <!-- Toggle Buttons -->
        <div class="button-group-toggle" style="margin-bottom: 20px">
          <button
            class="connection-toggle"
            id="connectionToggle"
            onclick="toggleConnectionSection()"
          >
            Hide Connection Section
          </button>
          <button
            class="connection-toggle"
            id="erDiagramToggle"
            onclick="toggleERDiagram()"
          >
            Show ER Diagram
          </button>
          <button
            class="connection-toggle"
            onclick="openAssignments()"
          >
            üìö SQL Assignments
          </button>
        </div>

        <!-- ER Diagram Container -->
        <div class="er-diagram-container" id="erDiagramContainer">
          <h3 style="color: #495057; margin-bottom: 15px">
            Database Schema - ER Diagram
          </h3>
          <img
            src="./static/images/er-diag.png"
            alt="Entity Relationship Diagram"
          />
        </div>

        <!-- Top Section: Connection and Status -->
        <div class="top-section" id="topSection">
          <div class="connection-form">
            <h3>
              <span
                id="connectionStatus"
                class="connection-status disconnected"
              ></span
              >Database Connection
            </h3>
            <div class="form-group">
              <label for="host">Host:</label>
              <input
                type="text"
                id="host"
                placeholder="your-endpoint.neon.tech"
                value=""
              />
            </div>
            <div class="form-group">
              <label for="database">Database:</label>
              <input
                type="text"
                id="database"
                placeholder="neondb"
                value="neondb"
              />
            </div>
            <div class="form-group">
              <label for="username">Username:</label>
              <input
                type="text"
                id="username"
                placeholder="your-username"
                value=""
              />
            </div>
            <div class="form-group">
              <label for="password">Password:</label>
              <input
                type="password"
                id="password"
                placeholder="your-password"
                value=""
              />
            </div>
            <button class="btn-connect" onclick="connectToDatabase()">
              <span id="connectText">Connect to Database</span>
            </button>
          </div>
        </div>

        <!-- SQL Query Section - Now at the top and full width -->
        <div class="query-section">
          <div class="query-input">
            <h3>SQL Query</h3>
            <div class="query-examples">
              <strong>Quick Examples:</strong><br />
              <button class="example-button" onclick="setExampleQuery('basic')">
                Basic SELECT
              </button>
              <button class="example-button" onclick="setExampleQuery('join')">
                JOIN Example
              </button>
              <button
                class="example-button"
                onclick="setExampleQuery('aggregate')"
              >
                Aggregation
              </button>
              <button
                class="example-button"
                onclick="setExampleQuery('window')"
              >
                Window Functions
              </button>
              <button
                class="example-button"
                onclick="setExampleQuery('complex')"
              >
                Complex Analysis
              </button>
            </div>
            <textarea
              id="sqlQuery"
              placeholder="Enter your SQL query here...

Example:
SELECT p.product_name, p.price, c.category_name 
FROM products p
JOIN categories c ON p.category_id = c.category_id
ORDER BY p.price DESC;"
            ></textarea>
            <div class="button-group">
              <button
                class="btn-primary"
                onclick="executeQuery()"
                id="executeBtn"
              >
                Execute Query
              </button>
              <button class="btn-secondary" onclick="clearQuery()">
                Clear
              </button>
            </div>
          </div>
        </div>

        <div class="results-section">
          <div id="statusMessage" class="status info">
            üëã Welcome! Connect to your Neon database and start querying.
          </div>
        </div>

        <!-- Results Section - Full width with horizontal scroll -->
        <div class="results-section">
          <div
            class="results-container"
            id="resultsContainer"
            style="display: none"
          >
            <div class="results-header">
              <h3>Query Results</h3>
              <div class="query-info" id="queryInfo"></div>
            </div>
            <div class="table-container">
              <div id="resultsContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let isConnected = false;
      let connectionId = null;
      const API_BASE = window.location.origin + "/api";

      // Example queries
      const exampleQueries = {
        basic: `-- Basic product listing
SELECT product_name, price, stock_quantity 
FROM products 
ORDER BY price DESC;`,

        join: `-- Products with categories
SELECT p.product_name, p.price, c.category_name
FROM products p
JOIN categories c ON p.category_id = c.category_id
ORDER BY c.category_name, p.product_name;`,

        aggregate: `-- Sales by category
SELECT c.category_name, 
       COUNT(oi.product_id) as total_sold,
       SUM(oi.total_price) as revenue
FROM categories c
LEFT JOIN products p ON c.category_id = p.category_id
LEFT JOIN order_items oi ON p.product_id = oi.product_id
GROUP BY c.category_id, c.category_name
ORDER BY revenue DESC NULLS LAST;`,

        window: `-- Customer ranking by total spending
SELECT c.first_name || ' ' || c.last_name as customer,
       SUM(o.total_amount) as total_spent,
       RANK() OVER (ORDER BY SUM(o.total_amount) DESC) as spending_rank
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.first_name, c.last_name
ORDER BY total_spent DESC NULLS LAST;`,

        complex: `-- Monthly sales trend with growth
WITH monthly_sales AS (
    SELECT DATE_TRUNC('month', order_date) as month,
           SUM(total_amount) as revenue,
           COUNT(*) as order_count
    FROM orders 
    GROUP BY DATE_TRUNC('month', order_date)
)
SELECT month,
       revenue,
       order_count,
       revenue - LAG(revenue) OVER (ORDER BY month) as growth,
       ROUND((revenue - LAG(revenue) OVER (ORDER BY month)) / 
             NULLIF(LAG(revenue) OVER (ORDER BY month), 0) * 100, 2) as growth_pct
FROM monthly_sales
ORDER BY month;`,
      };

      function setExampleQuery(type) {
        document.getElementById("sqlQuery").value = exampleQueries[type];
      }

      async function connectToDatabase() {
        const host = document.getElementById("host").value;
        const database = document.getElementById("database").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        if (!host || !username || !password) {
          showStatus("Please fill in all connection fields", "error");
          return;
        }

        // Show connecting state
        const connectBtn = document.querySelector(".btn-connect");
        const connectText = document.getElementById("connectText");
        const originalText = connectText.textContent;

        connectText.innerHTML = '<span class="loading"></span>Connecting...';
        connectBtn.disabled = true;

        try {
          const response = await fetch(`${API_BASE}/connect`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ host, database, username, password }),
          });

          const result = await response.json();

          if (result.success) {
            isConnected = true;
            connectionId = result.connectionId;

            document.getElementById("connectionStatus").className =
              "connection-status connected";
            showStatus(
              `‚úÖ Connected to ${result.serverInfo.database} successfully!`,
              "success"
            );

            connectText.textContent = "Connected ‚úì";
            connectBtn.style.background =
              "linear-gradient(135deg, #28a745 0%, #20c997 100%)";

            // Load schema information
            await loadSchema();
          } else {
            throw new Error(result.error || "Connection failed");
          }
        } catch (error) {
          console.error("Connection error:", error);
          showStatus(`‚ùå Connection failed: ${error.message}`, "error");

          connectText.textContent = originalText;
          connectBtn.style.background =
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
        } finally {
          connectBtn.disabled = false;
        }
      }

      async function loadSchema() {
        try {
          const response = await fetch(`${API_BASE}/schema`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ connectionId }),
          });

          const result = await response.json();
          if (result.success) {
            console.log("Database schema loaded:", result.schema);
            // You could display schema in UI here
          }
        } catch (error) {
          console.error("Schema loading error:", error);
        }
      }

      async function executeQuery() {
        if (!isConnected || !connectionId) {
          showStatus("Please connect to the database first", "error");
          return;
        }

        const query = document.getElementById("sqlQuery").value.trim();
        if (!query) {
          showStatus("Please enter a SQL query", "error");
          return;
        }

        // Show loading state
        const executeBtn = document.getElementById("executeBtn");
        const originalText = executeBtn.textContent;
        executeBtn.innerHTML = '<span class="loading"></span>Executing...';
        executeBtn.disabled = true;

        try {
          const response = await fetch(`${API_BASE}/query`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ connectionId, query }),
          });

          const result = await response.json();

          if (result.success) {
            displayResults(result.data, query);
          } else {
            // Display the actual database error from the server
            let errorMessage = result.error || "Unknown error occurred";
            
            // Add additional error details if available
            if (result.errorCode) {
              errorMessage += ` (Code: ${result.errorCode})`;
            }
            if (result.position) {
              errorMessage += ` at position ${result.position}`;
            }
            
            showStatus(`‚ùå ${errorMessage}`, "error");
            console.error("Query error details:", result);
          }
        } catch (error) {
          console.error("Query execution error:", error);
          
          // Check if it's a fetch/network error
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            showStatus(`‚ùå Connection error: Unable to reach the database server`, "error");
          } else {
            showStatus(`‚ùå Network error: ${error.message}`, "error");
          }
        } finally {
          executeBtn.textContent = originalText;
          executeBtn.disabled = false;
        }
      }

      function generateMockResults(query) {
        const queryLower = query.toLowerCase();

        if (
          queryLower.includes("products") &&
          queryLower.includes("categories")
        ) {
          return {
            rows: [
              {
                product_name: "iPhone 14 Pro",
                price: 32990.0,
                category_name: "Mobiln√≠ telefony",
              },
              {
                product_name: "MacBook Air M2",
                price: 35990.0,
                category_name: "Notebooky",
              },
              {
                product_name: "Dell XPS 13",
                price: 31990.0,
                category_name: "Notebooky",
              },
              {
                product_name: "Samsung Galaxy S23",
                price: 28990.0,
                category_name: "Mobiln√≠ telefony",
              },
              {
                product_name: "P√°nsk√° ko≈°ile",
                price: 1290.0,
                category_name: "P√°nsk√© obleƒçen√≠",
              },
            ],
            rowCount: 5,
            executionTime: 23,
          };
        } else if (
          queryLower.includes("customer") &&
          queryLower.includes("rank")
        ) {
          return {
            rows: [
              { customer: "Jan Nov√°k", total_spent: 68980.0, spending_rank: 1 },
              {
                customer: "Petr Dvo≈ô√°k",
                total_spent: 28990.0,
                spending_rank: 2,
              },
              {
                customer: "Marie Svobodov√°",
                total_spent: 35770.0,
                spending_rank: 3,
              },
              {
                customer: "Anna Kratochv√≠lov√°",
                total_spent: 698.0,
                spending_rank: 4,
              },
              {
                customer: "Tom√°≈° Proch√°zka",
                total_spent: 1890.0,
                spending_rank: 5,
              },
            ],
            rowCount: 5,
            executionTime: 31,
          };
        } else if (
          queryLower.includes("count") ||
          queryLower.includes("sum") ||
          queryLower.includes("group by")
        ) {
          return {
            rows: [
              {
                category_name: "Mobiln√≠ telefony",
                total_sold: 2,
                revenue: 61980.0,
              },
              { category_name: "Notebooky", total_sold: 2, revenue: 67980.0 },
              {
                category_name: "P√°nsk√© obleƒçen√≠",
                total_sold: 2,
                revenue: 3780.0,
              },
              {
                category_name: "D√°msk√© obleƒçen√≠",
                total_sold: 1,
                revenue: 1890.0,
              },
              { category_name: "Sci-Fi knihy", total_sold: 2, revenue: 698.0 },
            ],
            rowCount: 5,
            executionTime: 18,
          };
        } else {
          // Default product listing
          return {
            rows: [
              {
                product_id: 1,
                product_name: "iPhone 14 Pro",
                price: 32990.0,
                stock_quantity: 15,
              },
              {
                product_id: 2,
                product_name: "Samsung Galaxy S23",
                price: 28990.0,
                stock_quantity: 22,
              },
              {
                product_id: 3,
                product_name: "MacBook Air M2",
                price: 35990.0,
                stock_quantity: 8,
              },
              {
                product_id: 4,
                product_name: "Dell XPS 13",
                price: 31990.0,
                stock_quantity: 12,
              },
              {
                product_id: 5,
                product_name: "P√°nsk√° ko≈°ile",
                price: 1290.0,
                stock_quantity: 45,
              },
            ],
            rowCount: 5,
            executionTime: 12,
          };
        }
      }

      function displayResults(results, query) {
        const container = document.getElementById("resultsContainer");
        const content = document.getElementById("resultsContent");
        const queryInfo = document.getElementById("queryInfo");

        if (!results.rows || results.rows.length === 0) {
          content.innerHTML = '<div class="no-data">No data found</div>';
          queryInfo.textContent = `Query executed in ${results.executionTime}ms ‚Ä¢ 0 rows returned`;
          showStatus("Query executed successfully (no results)", "info");
          container.style.display = "block";
          return;
        }

        // Create table with horizontal scroll container
        const columns = Object.keys(results.rows[0]);
        let html = "<table><thead><tr>";

        columns.forEach((col) => {
          html += `<th>${col.replace(/_/g, " ").toUpperCase()}</th>`;
        });

        html += "</tr></thead><tbody>";

        results.rows.forEach((row) => {
          html += "<tr>";
          columns.forEach((col) => {
            let value = row[col];
            if (typeof value === "number" && value % 1 !== 0) {
              value = value.toFixed(2);
            }
            if (value === null || value === undefined) {
              value = `<em style='color: #999;'>NULL</em>`;
            }
            if (typeof value === "string" && value.length > 50) {
              // Show preview with title containing full value
              const preview = value.substring(0, 50) + "...";
              html += `<td title="${value.replace(
                /"/g,
                "&quot;"
              )}">${preview}</td>`;
            } else {
              html += `<td title="${value}">${value}</td>`;
            }
          });
          html += "</tr>";
        });

        html += "</tbody></table>";

        content.innerHTML = html;
        queryInfo.textContent = `Query executed in ${results.executionTime}ms ‚Ä¢ ${results.rowCount} rows returned`;
        showStatus(
          `‚úÖ Query executed successfully! Found ${results.rowCount} rows`,
          "success"
        );
        container.style.display = "block";
      }

      function showStatus(message, type) {
        const statusEl = document.getElementById("statusMessage");
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
      }

      function clearQuery() {
        document.getElementById("sqlQuery").value = "";
      }

      function toggleConnectionSection() {
        const topSection = document.getElementById("topSection");
        const toggleButton = document.getElementById("connectionToggle");

        if (topSection.classList.contains("hidden")) {
          topSection.classList.remove("hidden");
          toggleButton.textContent = "Hide Connection Section";
        } else {
          topSection.classList.add("hidden");
          toggleButton.textContent = "Show Connection Section";
        }
      }

      function toggleERDiagram() {
        const erContainer = document.getElementById("erDiagramContainer");
        const toggleButton = document.getElementById("erDiagramToggle");

        if (erContainer.classList.contains("visible")) {
          erContainer.classList.remove("visible");
          toggleButton.textContent = "Show ER Diagram";
        } else {
          erContainer.classList.add("visible");
          toggleButton.textContent = "Hide ER Diagram";
        }
      }

      function openAssignments() {
        window.open("assignments.html", "_blank");
      }

      // Load default configuration
      async function loadDefaultConfig() {
        try {
          const response = await fetch(`${API_BASE}/config`);
          const config = await response.json();

          document.getElementById("host").value = config.host || "";
          document.getElementById("database").value =
            config.database || "neondb";
          document.getElementById("username").value = config.username || "";

          console.log("Default configuration loaded");
        } catch (error) {
          console.error("Failed to load default configuration:", error);
        }
      }

      // Auto-connect using server-side credentials
      async function autoConnect() {
        try {
          showStatus("üîÑ Auto-connecting to database...", "info");

          const response = await fetch(`${API_BASE}/auto-connect`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (result.success) {
            isConnected = true;
            connectionId = result.connectionId;

            document.getElementById("connectionStatus").className =
              "connection-status connected";
            showStatus(
              `‚úÖ Auto-connected to ${result.serverInfo.database} successfully!`,
              "success"
            );

            // Update connect button
            const connectBtn = document.querySelector(".btn-connect");
            const connectText = document.getElementById("connectText");
            connectText.textContent = "Connected ‚úì";
            connectBtn.style.background =
              "linear-gradient(135deg, #28a745 0%, #20c997 100%)";

            // Hide connection form after successful auto-connect
            document.getElementById("topSection").classList.add("hidden");
            document.getElementById("connectionToggle").style.display = "block";
            document.getElementById("connectionToggle").textContent =
              "Show Connection Section";

            // Load schema information
            await loadSchema();
          } else {
            throw new Error(result.error || "Auto-connect failed");
          }
        } catch (error) {
          console.error("Auto-connect error:", error);
          showStatus(
            `‚ÑπÔ∏è Auto-connect failed: ${error.message}. Please use manual connection.`,
            "info"
          );

          // Ensure connection form is visible if auto-connect fails
          document.getElementById("topSection").classList.remove("hidden");
          document.getElementById("connectionToggle").textContent =
            "Hide Connection Section";
        }
      }

      // Initialize with a welcome message and load config
      showStatus("üîÑ Initializing application...", "info");

      // Load default configuration and attempt auto-connect
      async function initializeApp() {
        await loadDefaultConfig();
        await autoConnect();
      }

      // Initialize on page load
      initializeApp();
    </script>
  </body>
</html>
