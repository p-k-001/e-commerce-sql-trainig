<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQL Query Interface - E-commerce Database</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        padding: 30px;
        text-align: center;
        color: white;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .content {
        padding: 30px;
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      .top-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .query-section {
        grid-column: span 2;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .connection-form {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 15px;
        border: 1px solid #e9ecef;
      }

      .connection-form h3 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: #4facfe;
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
      }

      .query-input {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 15px;
        border: 1px solid #e9ecef;
        flex-grow: 1;
      }

      .query-input h3 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      .query-examples {
        margin-bottom: 20px;
      }

      .example-button {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        border: none;
        padding: 8px 15px;
        margin: 5px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        color: #333;
        transition: transform 0.2s ease;
      }

      .example-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      textarea {
        width: 100%;
        height: 200px;
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 14px;
        line-height: 1.5;
        resize: vertical;
        background: #ffffff;
        transition: border-color 0.3s ease;
      }

      textarea:focus {
        outline: none;
        border-color: #4facfe;
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
      }

      .button-group {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      button {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
      }

      .btn-connect {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        width: 100%;
      }

      .btn-connect:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
      }

      .results-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .status {
        padding: 15px;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
      }

      .status.success {
        background: #d1edff;
        color: #0c5460;
        border: 1px solid #b8daff;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .results-container {
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        max-height: 600px;
        overflow-y: auto;
      }

      .table-container {
        overflow-x: auto;
      }

      .results-header {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .results-header h3 {
        color: #495057;
        margin: 0;
      }

      .query-info {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      thead {
        background: #f8f9fa;
        position: sticky;
        top: 0;
      }

      th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
        min-width: 120px;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: top;
        white-space: nowrap;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      td:hover {
        white-space: normal;
        word-break: break-word;
        max-width: none;
      }

      tbody tr:hover {
        background: #f8f9ff;
      }

      tbody tr:nth-child(even) {
        background: #fafafa;
      }

      tbody tr:nth-child(even):hover {
        background: #f0f0ff;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
      }

      @media (max-width: 1024px) {
        .top-section {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .query-section {
          grid-column: span 1;
        }

        .content {
          padding: 20px;
          gap: 20px;
        }

        .table-container {
          font-size: 14px;
        }

        th,
        td {
          padding: 8px 6px;
          min-width: 100px;
        }
      }

      .connection-status {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .connection-status.connected {
        background: #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
      }

      .connection-status.disconnected {
        background: #dc3545;
      }

      .connection-toggle {
        background: transparent;
        border: 1px solid #dee2e6;
        color: #495057;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .connection-toggle:hover {
        background: #f8f9fa;
        border-color: #4facfe;
      }

      .connection-form.hidden {
        display: none;
      }

      .top-section.hidden {
        display: none;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>SQL Query Interface</h1>
        <p>E-commerce Database Explorer & Learning Tool</p>
      </div>

      <div class="content">
        <!-- SQL Query Section - Now at the top and full width -->
        <div class="query-section">
          <div class="query-input">
            <h3>SQL Query</h3>
            <div class="query-examples">
              <strong>Quick Examples:</strong><br />
              <button class="example-button" onclick="setExampleQuery('basic')">
                Basic SELECT
              </button>
              <button class="example-button" onclick="setExampleQuery('join')">
                JOIN Example
              </button>
              <button
                class="example-button"
                onclick="setExampleQuery('aggregate')"
              >
                Aggregation
              </button>
              <button
                class="example-button"
                onclick="setExampleQuery('window')"
              >
                Window Functions
              </button>
              <button
                class="example-button"
                onclick="setExampleQuery('complex')"
              >
                Complex Analysis
              </button>
            </div>
            <textarea
              id="sqlQuery"
              placeholder="Enter your SQL query here...

Example:
SELECT p.product_name, p.price, c.category_name 
FROM products p
JOIN categories c ON p.category_id = c.category_id
ORDER BY p.price DESC;"
            ></textarea>
            <div class="button-group">
              <button
                class="btn-primary"
                onclick="executeQuery()"
                id="executeBtn"
              >
                Execute Query
              </button>
              <button class="btn-secondary" onclick="clearQuery()">
                Clear
              </button>
            </div>
          </div>
        </div>

        <!-- Connection Toggle Button -->
        <div style="text-align: center; margin-bottom: 20px;">
          <button class="connection-toggle" id="connectionToggle" onclick="toggleConnectionSection()">
            Hide Connection Section
          </button>
        </div>

        <!-- Top Section: Connection and Status -->
        <div class="top-section" id="topSection">
          <div class="connection-form">
            <h3>
              <span
                id="connectionStatus"
                class="connection-status disconnected"
              ></span
              >Database Connection
            </h3>
            <div class="form-group">
              <label for="host">Host:</label>
              <input
                type="text"
                id="host"
                placeholder="your-endpoint.neon.tech"
                value=""
              />
            </div>
            <div class="form-group">
              <label for="database">Database:</label>
              <input
                type="text"
                id="database"
                placeholder="neondb"
                value="neondb"
              />
            </div>
            <div class="form-group">
              <label for="username">Username:</label>
              <input
                type="text"
                id="username"
                placeholder="your-username"
                value=""
              />
            </div>
            <div class="form-group">
              <label for="password">Password:</label>
              <input
                type="password"
                id="password"
                placeholder="your-password"
                value=""
              />
            </div>
            <button class="btn-connect" onclick="connectToDatabase()">
              <span id="connectText">Connect to Database</span>
            </button>
          </div>

          <div class="results-section">
            <div id="statusMessage" class="status info">
              👋 Welcome! Connect to your Neon database and start querying.
            </div>
          </div>
        </div>

        <!-- Results Section - Full width with horizontal scroll -->
        <div class="results-section">
          <div
            class="results-container"
            id="resultsContainer"
            style="display: none"
          >
            <div class="results-header">
              <h3>Query Results</h3>
              <div class="query-info" id="queryInfo"></div>
            </div>
            <div class="table-container">
              <div id="resultsContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let isConnected = false;
      let connectionId = null;
      const API_BASE = window.location.origin + "/api";

      // Example queries
      const exampleQueries = {
        basic: `-- Basic product listing
SELECT product_name, price, stock_quantity 
FROM products 
ORDER BY price DESC;`,

        join: `-- Products with categories
SELECT p.product_name, p.price, c.category_name
FROM products p
JOIN categories c ON p.category_id = c.category_id
ORDER BY c.category_name, p.product_name;`,

        aggregate: `-- Sales by category
SELECT c.category_name, 
       COUNT(oi.product_id) as total_sold,
       SUM(oi.total_price) as revenue
FROM categories c
LEFT JOIN products p ON c.category_id = p.category_id
LEFT JOIN order_items oi ON p.product_id = oi.product_id
GROUP BY c.category_id, c.category_name
ORDER BY revenue DESC NULLS LAST;`,

        window: `-- Customer ranking by total spending
SELECT c.first_name || ' ' || c.last_name as customer,
       SUM(o.total_amount) as total_spent,
       RANK() OVER (ORDER BY SUM(o.total_amount) DESC) as spending_rank
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.first_name, c.last_name
ORDER BY total_spent DESC NULLS LAST;`,

        complex: `-- Monthly sales trend with growth
WITH monthly_sales AS (
    SELECT DATE_TRUNC('month', order_date) as month,
           SUM(total_amount) as revenue,
           COUNT(*) as order_count
    FROM orders 
    GROUP BY DATE_TRUNC('month', order_date)
)
SELECT month,
       revenue,
       order_count,
       revenue - LAG(revenue) OVER (ORDER BY month) as growth,
       ROUND((revenue - LAG(revenue) OVER (ORDER BY month)) / 
             NULLIF(LAG(revenue) OVER (ORDER BY month), 0) * 100, 2) as growth_pct
FROM monthly_sales
ORDER BY month;`,
      };

      function setExampleQuery(type) {
        document.getElementById("sqlQuery").value = exampleQueries[type];
      }

      async function connectToDatabase() {
        const host = document.getElementById("host").value;
        const database = document.getElementById("database").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        if (!host || !username || !password) {
          showStatus("Please fill in all connection fields", "error");
          return;
        }

        // Show connecting state
        const connectBtn = document.querySelector(".btn-connect");
        const connectText = document.getElementById("connectText");
        const originalText = connectText.textContent;

        connectText.innerHTML = '<span class="loading"></span>Connecting...';
        connectBtn.disabled = true;

        try {
          const response = await fetch(`${API_BASE}/connect`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ host, database, username, password }),
          });

          const result = await response.json();

          if (result.success) {
            isConnected = true;
            connectionId = result.connectionId;

            document.getElementById("connectionStatus").className =
              "connection-status connected";
            showStatus(
              `✅ Connected to ${result.serverInfo.database} successfully!`,
              "success"
            );

            connectText.textContent = "Connected ✓";
            connectBtn.style.background =
              "linear-gradient(135deg, #28a745 0%, #20c997 100%)";

            // Load schema information
            await loadSchema();
          } else {
            throw new Error(result.error || "Connection failed");
          }
        } catch (error) {
          console.error("Connection error:", error);
          showStatus(`❌ Connection failed: ${error.message}`, "error");

          connectText.textContent = originalText;
          connectBtn.style.background =
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
        } finally {
          connectBtn.disabled = false;
        }
      }

      async function loadSchema() {
        try {
          const response = await fetch(`${API_BASE}/schema`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ connectionId }),
          });

          const result = await response.json();
          if (result.success) {
            console.log("Database schema loaded:", result.schema);
            // You could display schema in UI here
          }
        } catch (error) {
          console.error("Schema loading error:", error);
        }
      }

      async function executeQuery() {
        if (!isConnected || !connectionId) {
          showStatus("Please connect to the database first", "error");
          return;
        }

        const query = document.getElementById("sqlQuery").value.trim();
        if (!query) {
          showStatus("Please enter a SQL query", "error");
          return;
        }

        // Show loading state
        const executeBtn = document.getElementById("executeBtn");
        const originalText = executeBtn.textContent;
        executeBtn.innerHTML = '<span class="loading"></span>Executing...';
        executeBtn.disabled = true;

        try {
          const response = await fetch(`${API_BASE}/query`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ connectionId, query }),
          });

          const result = await response.json();

          if (result.success) {
            displayResults(result.data, query);
          } else {
            showStatus(`❌ Query Error: ${result.error}`, "error");
            console.error("Query error details:", result);
          }
        } catch (error) {
          console.error("Query execution error:", error);
          showStatus(`❌ Network error: ${error.message}`, "error");
        } finally {
          executeBtn.textContent = originalText;
          executeBtn.disabled = false;
        }
      }

      function generateMockResults(query) {
        const queryLower = query.toLowerCase();

        if (
          queryLower.includes("products") &&
          queryLower.includes("categories")
        ) {
          return {
            rows: [
              {
                product_name: "iPhone 14 Pro",
                price: 32990.0,
                category_name: "Mobilní telefony",
              },
              {
                product_name: "MacBook Air M2",
                price: 35990.0,
                category_name: "Notebooky",
              },
              {
                product_name: "Dell XPS 13",
                price: 31990.0,
                category_name: "Notebooky",
              },
              {
                product_name: "Samsung Galaxy S23",
                price: 28990.0,
                category_name: "Mobilní telefony",
              },
              {
                product_name: "Pánská košile",
                price: 1290.0,
                category_name: "Pánské oblečení",
              },
            ],
            rowCount: 5,
            executionTime: 23,
          };
        } else if (
          queryLower.includes("customer") &&
          queryLower.includes("rank")
        ) {
          return {
            rows: [
              { customer: "Jan Novák", total_spent: 68980.0, spending_rank: 1 },
              {
                customer: "Petr Dvořák",
                total_spent: 28990.0,
                spending_rank: 2,
              },
              {
                customer: "Marie Svobodová",
                total_spent: 35770.0,
                spending_rank: 3,
              },
              {
                customer: "Anna Kratochvílová",
                total_spent: 698.0,
                spending_rank: 4,
              },
              {
                customer: "Tomáš Procházka",
                total_spent: 1890.0,
                spending_rank: 5,
              },
            ],
            rowCount: 5,
            executionTime: 31,
          };
        } else if (
          queryLower.includes("count") ||
          queryLower.includes("sum") ||
          queryLower.includes("group by")
        ) {
          return {
            rows: [
              {
                category_name: "Mobilní telefony",
                total_sold: 2,
                revenue: 61980.0,
              },
              { category_name: "Notebooky", total_sold: 2, revenue: 67980.0 },
              {
                category_name: "Pánské oblečení",
                total_sold: 2,
                revenue: 3780.0,
              },
              {
                category_name: "Dámské oblečení",
                total_sold: 1,
                revenue: 1890.0,
              },
              { category_name: "Sci-Fi knihy", total_sold: 2, revenue: 698.0 },
            ],
            rowCount: 5,
            executionTime: 18,
          };
        } else {
          // Default product listing
          return {
            rows: [
              {
                product_id: 1,
                product_name: "iPhone 14 Pro",
                price: 32990.0,
                stock_quantity: 15,
              },
              {
                product_id: 2,
                product_name: "Samsung Galaxy S23",
                price: 28990.0,
                stock_quantity: 22,
              },
              {
                product_id: 3,
                product_name: "MacBook Air M2",
                price: 35990.0,
                stock_quantity: 8,
              },
              {
                product_id: 4,
                product_name: "Dell XPS 13",
                price: 31990.0,
                stock_quantity: 12,
              },
              {
                product_id: 5,
                product_name: "Pánská košile",
                price: 1290.0,
                stock_quantity: 45,
              },
            ],
            rowCount: 5,
            executionTime: 12,
          };
        }
      }

      function displayResults(results, query) {
        const container = document.getElementById("resultsContainer");
        const content = document.getElementById("resultsContent");
        const queryInfo = document.getElementById("queryInfo");

        if (!results.rows || results.rows.length === 0) {
          content.innerHTML = '<div class="no-data">No data found</div>';
          queryInfo.textContent = `Query executed in ${results.executionTime}ms • 0 rows returned`;
          showStatus("Query executed successfully (no results)", "info");
          container.style.display = "block";
          return;
        }

        // Create table with horizontal scroll container
        const columns = Object.keys(results.rows[0]);
        let html = "<table><thead><tr>";

        columns.forEach((col) => {
          html += `<th>${col.replace(/_/g, " ").toUpperCase()}</th>`;
        });

        html += "</tr></thead><tbody>";

        results.rows.forEach((row) => {
          html += "<tr>";
          columns.forEach((col) => {
            let value = row[col];
            if (typeof value === "number" && value % 1 !== 0) {
              value = value.toFixed(2);
            }
            if (value === null || value === undefined) {
              value = '<em style="color: #999;">NULL</em>';
            }
            if (typeof value === "string" && value.length > 50) {
              // Show preview with title containing full value
              const preview = value.substring(0, 50) + "...";
              html += `<td title="${value.replace(
                /"/g,
                "&quot;"
              )}">${preview}</td>`;
            } else {
              html += `<td title="${value}">${value}</td>`;
            }
          });
          html += "</tr>";
        });

        html += "</tbody></table>";

        content.innerHTML = html;
        queryInfo.textContent = `Query executed in ${results.executionTime}ms • ${results.rowCount} rows returned`;
        showStatus(
          `✅ Query executed successfully! Found ${results.rowCount} rows`,
          "success"
        );
        container.style.display = "block";
      }

      function showStatus(message, type) {
        const statusEl = document.getElementById("statusMessage");
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
      }

      function clearQuery() {
        document.getElementById("sqlQuery").value = "";
      }

      function toggleConnectionSection() {
        const topSection = document.getElementById("topSection");
        const toggleButton = document.getElementById("connectionToggle");
        
        if (topSection.classList.contains("hidden")) {
          topSection.classList.remove("hidden");
          toggleButton.textContent = "Hide Connection Section";
        } else {
          topSection.classList.add("hidden");
          toggleButton.textContent = "Show Connection Section";
        }
      }

      // Load default configuration
      async function loadDefaultConfig() {
        try {
          const response = await fetch(`${API_BASE}/config`);
          const config = await response.json();
          
          document.getElementById("host").value = config.host || "";
          document.getElementById("database").value = config.database || "neondb";
          document.getElementById("username").value = config.username || "";
          
          console.log("Default configuration loaded");
        } catch (error) {
          console.error("Failed to load default configuration:", error);
        }
      }

      // Auto-connect using server-side credentials
      async function autoConnect() {
        try {
          showStatus("🔄 Auto-connecting to database...", "info");
          
          const response = await fetch(`${API_BASE}/auto-connect`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            }
          });

          const result = await response.json();

          if (result.success) {
            isConnected = true;
            connectionId = result.connectionId;

            document.getElementById("connectionStatus").className = "connection-status connected";
            showStatus(`✅ Auto-connected to ${result.serverInfo.database} successfully!`, "success");

            // Update connect button
            const connectBtn = document.querySelector(".btn-connect");
            const connectText = document.getElementById("connectText");
            connectText.textContent = "Connected ✓";
            connectBtn.style.background = "linear-gradient(135deg, #28a745 0%, #20c997 100%)";

            // Hide connection form after successful auto-connect
            document.getElementById("topSection").classList.add("hidden");
            document.getElementById("connectionToggle").style.display = "block";
            document.getElementById("connectionToggle").textContent = "Show Connection Section";

            // Load schema information
            await loadSchema();
          } else {
            throw new Error(result.error || "Auto-connect failed");
          }
        } catch (error) {
          console.error("Auto-connect error:", error);
          showStatus(`ℹ️ Auto-connect failed: ${error.message}. Please use manual connection.`, "info");
          
          // Ensure connection form is visible if auto-connect fails
          document.getElementById("topSection").classList.remove("hidden");
          document.getElementById("connectionToggle").textContent = "Hide Connection Section";
        }
      }

      // Initialize with a welcome message and load config
      showStatus(
        "🔄 Initializing application...",
        "info"
      );
      
      // Load default configuration and attempt auto-connect
      async function initializeApp() {
        await loadDefaultConfig();
        await autoConnect();
      }
      
      // Initialize on page load
      initializeApp();
    </script>
  </body>
</html>
